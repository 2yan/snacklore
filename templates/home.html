{% extends "base.html" %}

{% block title %}Snacklore | Global Recipe Explorer{% endblock %}

{% block extra_head %}
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') }}">
{% endblock %}

{% block content %}
    <!-- Hero Section -->
    <header class="hero">
      <h1>Taste the World</h1>
      <p>Discover authentic recipes from over 200 countries and regions.</p>
      <div class="search-bar">
        <input type="text" placeholder="What are you craving today?" />
        <button>Search</button>
      </div>
    </header>

    <div class="home-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <!-- Map Explorer -->
      <div class="section-header">
        <h2>Explore by Region</h2>
        <p>Click on a country to discover its culinary traditions</p>
      </div>

      <div class="map-section">
        <div class="map-wrapper">
          <div id="map"></div>
          <div class="map-stats">
            <div class="map-stats-item">
              <div class="stat-number" id="country-count">0</div>
              <div class="stat-label">Countries</div>
            </div>
            <div class="map-stats-divider"></div>
            <div class="map-stats-item">
              <div class="stat-number" id="region-count">0</div>
              <div class="stat-label">Regions</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="footer-content">
        <div class="footer-col">
          <div class="logo footer-logo-white">
            Snacklore
          </div>
          <p class="footer-text-light">
            Bringing the world's kitchen to your home. Discover, cook, and share
            recipes from every corner of the globe.
          </p>
        </div>
        <div class="footer-col">
          <h3>Explore</h3>
          <ul class="footer-links">
            <li><a href="{{ url_for('world_map') }}">World Map</a></li>
            <li><a href="{{ url_for('directory') }}">Directory</a></li>
            <li><a href="{{ url_for('index') }}">Home</a></li>
            <li><a href="{{ url_for('directory') }}">All Recipes</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>Account</h3>
          <ul class="footer-links">
            {% if current_user and current_user.is_authenticated %}
            <li><a href="{{ url_for('user_profile', username=current_user.username) }}">My Profile</a></li>
            <li><a href="{{ url_for('logout') }}">Log Out</a></li>
            {% else %}
            <li><a href="{{ url_for('login') }}">Log In</a></li>
            <li><a href="{{ url_for('register') }}">Sign Up</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
      <div class="copyright">
        <p>&copy; 2024 Snacklore. All rights reserved.</p>
      </div>
    </footer>
{% endblock %}

{% block extra_js %}
    <!-- Leaflet JavaScript -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // Initialize the map centered on the world
      const map = L.map("map", {
        scrollWheelZoom: false,
        minZoom: 2,
        maxZoom: 8,
      }).setView([20, 0], 2);

      // Add class for zoom-based styling
      map.on("zoomend", function () {
        if (map.getZoom() < 4) {
          document.getElementById("map").classList.add("map-zoomed-out");
        } else {
          document.getElementById("map").classList.remove("map-zoomed-out");
        }
      });

      // Initialize zoom state
      document.getElementById("map").classList.add("map-zoomed-out");

      // Add a clean, light map layer (CartoDB Positron) for better aesthetics
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: "abcd",
          maxZoom: 19,
        }
      ).addTo(map);

      // Styling for the country polygons
      function getCountryStyle(feature) {
        return {
          fillColor: "#000000",
          weight: 1,
          opacity: 1,
          color: "white",
          dashArray: "3",
          fillOpacity: 0.1,
        };
      }

      function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({
          weight: 2,
          color: "#000000",
          dashArray: "",
          fillOpacity: 0.3,
        });
        layer.bringToFront();
      }

      function resetHighlight(e) {
        geojsonLayer.resetStyle(e.target);
      }

      // Global variables
      let geojsonLayer;
      let culinaryData = {}; // Stores our countries.json data indexed by country name

      // Mapping of country names to ISO 2-letter codes for flags
      const countryCodeMap = {
        Afghanistan: "af",
        Albania: "al",
        Algeria: "dz",
        Andorra: "ad",
        Angola: "ao",
        "Antigua and Barbuda": "ag",
        Argentina: "ar",
        Armenia: "am",
        Australia: "au",
        Austria: "at",
        Azerbaijan: "az",
        Bahamas: "bs",
        Bahrain: "bh",
        Bangladesh: "bd",
        Barbados: "bb",
        Belarus: "by",
        Belgium: "be",
        Belize: "bz",
        Benin: "bj",
        Bhutan: "bt",
        Bolivia: "bo",
        "Bosnia and Herzegovina": "ba",
        Botswana: "bw",
        Brazil: "br",
        Brunei: "bn",
        Bulgaria: "bg",
        "Burkina Faso": "bf",
        Burundi: "bi",
        Cambodia: "kh",
        Cameroon: "cm",
        Canada: "ca",
        "Cape Verde": "cv",
        "Central African Republic": "cf",
        Chad: "td",
        Chile: "cl",
        China: "cn",
        Colombia: "co",
        Comoros: "km",
        Congo: "cg",
        "Costa Rica": "cr",
        Croatia: "hr",
        Cuba: "cu",
        Cyprus: "cy",
        "Czech Republic": "cz",
        "Democratic Republic of the Congo": "cd",
        Denmark: "dk",
        Djibouti: "dj",
        Dominica: "dm",
        "Dominican Republic": "do",
        "East Timor": "tl",
        Ecuador: "ec",
        Egypt: "eg",
        "El Salvador": "sv",
        "Equatorial Guinea": "gq",
        Eritrea: "er",
        Estonia: "ee",
        Eswatini: "sz",
        Ethiopia: "et",
        Fiji: "fj",
        Finland: "fi",
        France: "fr",
        Gabon: "ga",
        Gambia: "gm",
        Georgia: "ge",
        Germany: "de",
        Ghana: "gh",
        Greece: "gr",
        Grenada: "gd",
        Guatemala: "gt",
        Guinea: "gn",
        "Guinea-Bissau": "gw",
        Guyana: "gy",
        Haiti: "ht",
        Honduras: "hn",
        Hungary: "hu",
        Iceland: "is",
        India: "in",
        Indonesia: "id",
        Iran: "ir",
        Iraq: "iq",
        Ireland: "ie",
        Israel: "il",
        Italy: "it",
        "Ivory Coast": "ci",
        Jamaica: "jm",
        Japan: "jp",
        Jordan: "jo",
        Kazakhstan: "kz",
        Kenya: "ke",
        Kiribati: "ki",
        "North Korea": "kp",
        "South Korea": "kr",
        Kosovo: "xk",
        Kuwait: "kw",
        Kyrgyzstan: "kg",
        Laos: "la",
        Latvia: "lv",
        Lebanon: "lb",
        Lesotho: "ls",
        Liberia: "lr",
        Libya: "ly",
        Liechtenstein: "li",
        Lithuania: "lt",
        Luxembourg: "lu",
        Macedonia: "mk",
        Madagascar: "mg",
        Malawi: "mw",
        Malaysia: "my",
        Maldives: "mv",
        Mali: "ml",
        Malta: "mt",
        "Marshall Islands": "mh",
        Mauritania: "mr",
        Mauritius: "mu",
        Mexico: "mx",
        Micronesia: "fm",
        Moldova: "md",
        Monaco: "mc",
        Mongolia: "mn",
        Montenegro: "me",
        Morocco: "ma",
        Mozambique: "mz",
        Myanmar: "mm",
        Namibia: "na",
        Nauru: "nr",
        Nepal: "np",
        Netherlands: "nl",
        "New Zealand": "nz",
        Nicaragua: "ni",
        Niger: "ne",
        Nigeria: "ng",
        Norway: "no",
        Oman: "om",
        Pakistan: "pk",
        Palau: "pw",
        Panama: "pa",
        "Papua New Guinea": "pg",
        Paraguay: "py",
        Peru: "pe",
        Philippines: "ph",
        Poland: "pl",
        Portugal: "pt",
        Qatar: "qa",
        Romania: "ro",
        Russia: "ru",
        Rwanda: "rw",
        "Saint Kitts and Nevis": "kn",
        "Saint Lucia": "lc",
        "Saint Vincent and the Grenadines": "vc",
        Samoa: "ws",
        "San Marino": "sm",
        "Sao Tome and Principe": "st",
        "Saudi Arabia": "sa",
        Senegal: "sn",
        Serbia: "rs",
        Seychelles: "sc",
        "Sierra Leone": "sl",
        Singapore: "sg",
        Slovakia: "sk",
        Slovenia: "si",
        "Solomon Islands": "sb",
        Somalia: "so",
        "South Africa": "za",
        "South Sudan": "ss",
        Spain: "es",
        "Sri Lanka": "lk",
        Sudan: "sd",
        Suriname: "sr",
        Sweden: "se",
        Switzerland: "ch",
        Syria: "sy",
        Taiwan: "tw",
        Tajikistan: "tj",
        Tanzania: "tz",
        Thailand: "th",
        Togo: "tg",
        Tonga: "to",
        "Trinidad and Tobago": "tt",
        Tunisia: "tn",
        Turkey: "tr",
        Turkmenistan: "tm",
        Tuvalu: "tv",
        Uganda: "ug",
        Ukraine: "ua",
        "United Arab Emirates": "ae",
        "United Kingdom": "gb",
        "United States": "us",
        Uruguay: "uy",
        Uzbekistan: "uz",
        Vanuatu: "vu",
        "Vatican City": "va",
        Venezuela: "ve",
        Vietnam: "vn",
        Yemen: "ye",
        Zambia: "zm",
        Zimbabwe: "zw",
      };

      // Ensure SVG has defs for patterns
      const mapDiv = document.getElementById("map");

      // We need to wait for Leaflet to create the SVG pane.
      // Usually initialized after first layer add, but let's hook into the process.
      // Simpler: Just access it when needed in onEachFeature or via a helper.

      function getDefs() {
        const svg = map.getPanes().overlayPane.querySelector("svg");
        if (!svg) return null;
        let defs = svg.querySelector("defs");
        if (!defs) {
          defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
          svg.prepend(defs);
        }
        return defs;
      }

      // Load data in parallel
      Promise.all([
        fetch(
          "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
        ).then((res) => res.json()),
        fetch("{{ url_for('static', filename='countries.json') }}").then(
          (res) => res.json()
        ),
      ])
        .then(([geoData, recipesData]) => {
          // Process recipe data for easy lookup
          let totalRegions = 0;
          recipesData.forEach((item) => {
            // Normalize name for better matching
            culinaryData[item.country] = item;
            if (item.regions) totalRegions += item.regions.length;
          });

          // Update stats
          document.getElementById("country-count").textContent =
            recipesData.length;
          document.getElementById("region-count").textContent = totalRegions;

          recipesData.forEach((country) => {
            if (country.lat && country.lng) {
              const marker = L.marker([country.lat, country.lng]).addTo(map);
              const slug = country.country.toLowerCase().replace(/ /g, "-");
              const url = "/c/" + slug;

              // Navigate to country page on click
              marker.on("click", function () {
                window.location.href = url;
              });

              // Add a text label (tooltip)
              marker.bindTooltip(country.country, {
                permanent: true,
                direction: "top",
                className: "country-label",
                offset: [0, -10],
              });
            }
          });

          // Add GeoJSON to map (Polygons)
          geojsonLayer = L.geoJson(geoData, {
            style: function (feature) {
              // Default style
              let style = {
                weight: 1,
                opacity: 1,
                color: "white",
                dashArray: "3",
                fillOpacity: 0.1,
                fillColor: "#000000",
              };

              // Try to add flag pattern
              const name = feature.properties.name;
              const code = countryCodeMap[name];

              if (code) {
                const defs = getDefs();
                if (defs) {
                  const patternId = "flag-" + code;
                  if (!document.getElementById(patternId)) {
                    const pattern = document.createElementNS(
                      "http://www.w3.org/2000/svg",
                      "pattern"
                    );
                    pattern.setAttribute("id", patternId);
                    pattern.setAttribute("patternUnits", "objectBoundingBox");
                    pattern.setAttribute(
                      "patternContentUnits",
                      "objectBoundingBox"
                    );
                    pattern.setAttribute("width", "1");
                    pattern.setAttribute("height", "1");

                    const image = document.createElementNS(
                      "http://www.w3.org/2000/svg",
                      "image"
                    );
                    // Use flagcdn or similar
                    image.setAttributeNS(
                      "http://www.w3.org/1999/xlink",
                      "href",
                      `https://flagcdn.com/w320/${code}.png`
                    );
                    image.setAttribute("width", "1");
                    image.setAttribute("height", "1");
                    // 'none' stretches the flag to fit the country shape, ensuring the full flag is visible
                    image.setAttribute("preserveAspectRatio", "none");

                    pattern.appendChild(image);
                    defs.appendChild(pattern);
                  }

                  // Use the pattern
                  style.fillColor = `url(#${patternId})`;
                  style.fillOpacity = 0.3; // Make it semi-transparent as requested
                  style.color = "#000000"; // Border color
                }
              }

              return style;
            },
            onEachFeature: function (feature, layer) {
              const countryName = feature.properties.name;
              const slug = countryName.toLowerCase().replace(/ /g, "-");
              const url = "/c/" + slug;
              
              layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: function () {
                  window.location.href = url;
                },
              });
            },
          }).addTo(map);
        })
        .catch((err) => console.error("Error loading map data:", err));
    </script>
{% endblock %}
