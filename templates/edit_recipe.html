{% extends 'base.html' %}

{% block title %}Edit Recipe - Snacklore{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
    <div class="flex justify-between items-center pb-4 border-b">
        <h1 class="font-cinzel text-3xl font-bold">Edit Recipe</h1>
        <a href="{{ url_for('recipe_detail_country', country_slug=recipe.primary_country.name|lower|replace(' ', '-') if recipe.primary_country else 'none', recipe_slug=recipe.slug) }}" class="btn btn-outline">
            View Recipe
        </a>
    </div>

    <!-- Metadata Form -->
    <div class="card p-6">
        <h2 class="text-xl font-bold mb-4">Basic Info</h2>
        <form method="POST" class="space-y-4">
            <div class="space-y-2">
                <label for="name" class="text-sm font-medium">Recipe Name</label>
                <input type="text" name="name" id="name" value="{{ recipe.name }}" required 
                       class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label for="country_id" class="text-sm font-medium">Country</label>
                    <select name="country_id" id="country_id" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                        <option value="">Select Country</option>
                        {% for country in countries %}
                        <option value="{{ country.id }}" {% if recipe.primary_country_id == country.id %}selected{% endif %}>{{ country.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="space-y-2">
                    <label for="state_id" class="text-sm font-medium">State/Region</label>
                    <select name="state_id" id="state_id" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                        <option value="">Select State</option>
                        {% if recipe.primary_country %}
                            {% for state in recipe.primary_country.states %}
                            <option value="{{ state.id }}" {% if recipe.primary_state_id == state.id %}selected{% endif %}>{{ state.name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>

    <!-- Steps & Ingredients -->
    <div class="space-y-6">
        <h2 class="text-xl font-bold">Steps & Ingredients</h2>
        
        {% for step in recipe.steps %}
        <div class="card p-6 relative group">
            <form action="{{ url_for('delete_step', recipe_id=recipe.id, step_id=step.id) }}" method="POST" class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity" onsubmit="return confirm('Delete this step?');">
                <button type="submit" class="text-destructive hover:bg-destructive/10 p-2 rounded">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </form>

            <h3 class="font-bold mb-2">Step {{ step.step_number }}</h3>
            <p class="mb-4 text-muted-foreground">{{ step.step_text }}</p>

            <div class="bg-muted/50 p-4 rounded-md mb-4">
                <h4 class="text-sm font-medium mb-2">Ingredients</h4>
                <ul class="space-y-2 mb-4">
                    {% for ingredient in step.ingredients %}
                    <li class="flex items-center justify-between text-sm bg-background p-2 rounded">
                        <span>{{ ingredient.amount }} {{ ingredient.name }}</span>
                        <form action="{{ url_for('delete_ingredient', recipe_id=recipe.id, ingredient_id=ingredient.id) }}" method="POST" class="inline">
                            <button type="submit" class="text-destructive hover:text-destructive/80 ml-2">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>

                <form action="{{ url_for('add_ingredient', recipe_id=recipe.id, step_id=step.id) }}" method="POST" class="flex gap-2">
                    <input type="text" name="amount" placeholder="Amount (e.g. 1 cup)" required class="flex h-9 w-1/3 rounded-md border border-input bg-background px-3 py-1 text-sm">
                    <input type="text" name="name" placeholder="Ingredient name" required class="flex h-9 w-2/3 rounded-md border border-input bg-background px-3 py-1 text-sm">
                    <button type="submit" class="btn btn-secondary btn-sm">Add</button>
                </form>
            </div>
        </div>
        {% endfor %}

        <!-- Add Step Form -->
        <div class="card p-6 border-dashed">
            <h3 class="font-bold mb-4">Add Next Step</h3>
            <form action="{{ url_for('add_step', recipe_id=recipe.id) }}" method="POST" class="space-y-4">
                <textarea name="step_text" rows="3" placeholder="Describe this step..." required class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"></textarea>
                <button type="submit" class="btn btn-outline w-full">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Step
                </button>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Reuse the state loading script from new_recipe
document.getElementById('country_id').addEventListener('change', function() {
    const countryId = this.value;
    const stateSelect = document.getElementById('state_id');
    
    if (!countryId) {
        stateSelect.innerHTML = '<option value="">Select State</option>';
        return;
    }
    
    fetch(`/api/states/${countryId}`)
        .then(response => response.json())
        .then(data => {
            stateSelect.innerHTML = '<option value="">Select State</option>';
            data.states.forEach(state => {
                const option = document.createElement('option');
                option.value = state.id;
                option.textContent = state.name;
                stateSelect.appendChild(option);
            });
        });
});
</script>
{% endblock %}
{% endblock %}

