<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ recipe.name }} - Snacklore</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            min-height: 100vh;
            padding: 0;
        }
        .container {
            background: #fff;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            border: 1px solid #333;
            border-top: none;
            margin-top: 0;
        }
        h1 { margin-bottom: 1.5rem; color: #000; }
        .recipe-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #666;
        }
        .recipe-info {
            color: #666;
            margin-top: 0.5rem;
        }
        .steps-section {
            margin-top: 2rem;
        }
        .steps-list {
            list-style: none;
            margin-top: 1rem;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            position: relative;
            cursor: move;
            transition: background 0.2s, border-color 0.2s;
        }
        .step:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        .step.dragging {
            opacity: 0.5;
            background: #e0e0e0;
        }
        .drag-handle {
            cursor: grab;
            color: #666;
            font-size: 1.2rem;
            user-select: none;
            flex-shrink: 0;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .step-number {
            font-weight: 600;
            color: #000;
            font-size: 0.9rem;
            min-width: 50px;
            flex-shrink: 0;
        }
        .step-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 0;
        }
        .step-text {
            flex: 1;
            color: #333;
            cursor: text;
            padding: 0.25rem 0.5rem;
            min-height: 1.5rem;
            line-height: 1.5;
        }
        .step-text.editing {
            border: 1px solid #666;
            background: #fff;
            border-radius: 3px;
        }
        .step-text-input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #666;
            font-size: 1rem;
            background: #fff;
            color: #000;
            border-radius: 3px;
            font-family: inherit;
        }
        .ingredients-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex-shrink: 0;
            max-width: 40%;
            position: relative;
        }
        .ingredient-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: #e8e8e8;
            border: 1px solid #ccc;
            border-radius: 12px;
            font-size: 0.85rem;
            color: #333;
            cursor: text;
            white-space: nowrap;
            position: relative;
        }
        .ingredient-chip:hover {
            background: #ddd;
        }
        .ingredient-chip .ingredient-name {
            font-weight: 500;
        }
        .ingredient-chip .ingredient-amount {
            color: #666;
            font-size: 0.8rem;
        }
        .ingredient-chip .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 0;
            margin-left: 0.25rem;
            font-size: 1rem;
            line-height: 1;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ingredient-chip .delete-btn:hover {
            color: #000;
        }
        .step-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .new-ingredient-btn {
            display: none;
            padding: 0.25rem 0.75rem;
            background: #666;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .new-ingredient-btn:hover {
            background: #555;
        }
        .step-creating .new-ingredient-btn {
            display: inline-block;
        }
        .new-step-form {
            display: none;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: #f0f0f0;
            border: 2px dashed #999;
            border-radius: 4px;
        }
        .new-step-form.active {
            display: block;
        }
        .new-step-form-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .new-step-form-content input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #666;
            font-size: 1rem;
            background: #fff;
            color: #000;
            border-radius: 3px;
            font-family: inherit;
        }
        .new-step-form-actions {
            display: flex;
            gap: 0.5rem;
        }
        .new-ingredient-form {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #fff;
            border: 2px solid #666;
            border-radius: 4px;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .new-ingredient-form.active {
            display: block;
        }
        .new-ingredient-form-content {
            display: flex;
            gap: 0.5rem;
        }
        .new-ingredient-form-content input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #666;
            font-size: 0.9rem;
            background: #fff;
            color: #000;
            border-radius: 3px;
            font-family: inherit;
        }
        .edit-mode {
            display: none;
        }
        .edit-mode.active {
            display: block;
        }
        .view-mode {
            display: block;
        }
        .view-mode.hidden {
            display: none;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #666;
            font-size: 1rem;
            background: #fff;
            color: #000;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button, .btn {
            padding: 0.5rem 1rem;
            background: #000;
            color: white;
            border: 2px solid #000;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
            border-radius: 3px;
            font-family: inherit;
        }
        button:hover, .btn:hover { background: #333; border-color: #333; }
        .btn-secondary {
            background: #666;
            border-color: #666;
        }
        .btn-secondary:hover { background: #555; border-color: #555; }
        .btn-danger {
            background: #000;
            border-color: #000;
        }
        .btn-danger:hover { background: #333; border-color: #333; }
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        .action-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        .flash-messages {
            margin-bottom: 1rem;
        }
        .flash {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #666;
        }
        .flash.error { background: #f5f5f5; color: #000; }
        .flash.success { background: #f5f5f5; color: #000; }
        .flash.info { background: #f5f5f5; color: #000; }
        .back-link {
            margin-bottom: 1rem;
        }
        .back-link a {
            color: #000;
            text-decoration: none;
        }
        .back-link a:hover { text-decoration: underline; }
        .new-step-btn {
            margin-top: 1rem;
        }
        .ingredient-edit-form {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #fff;
            border: 2px solid #666;
            border-radius: 4px;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 300px;
        }
        .ingredient-edit-form.active {
            display: block;
        }
        .ingredient-edit-form-content {
            display: flex;
            gap: 0.5rem;
        }
        .ingredient-edit-form-content input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #666;
            font-size: 0.9rem;
            background: #fff;
            color: #000;
            border-radius: 3px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    {% include 'includes/header.html' %}
    <div class="container">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div class="recipe-header">
            <div class="view-mode" id="recipe-name-view">
                <h1>{{ recipe.name }}</h1>
                <div class="recipe-info">
                    {% if recipe.primary_country %}Country: {{ recipe.primary_country.name }}{% endif %}
                    {% if recipe.primary_state %} | State: {{ recipe.primary_state.name }}{% endif %}
                    {% if is_owner %}
                        <button onclick="enableEditMode()" style="margin-left: 1rem;">Edit Recipe</button>
                    {% endif %}
                </div>
            </div>
            <div class="edit-mode" id="recipe-name-edit">
                <form method="POST" action="{{ url_for('edit_recipe', recipe_id=recipe.id) }}">
                    <input type="text" name="name" value="{{ recipe.name }}" required style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">
                    <div style="margin-top: 0.5rem;">
                        <select name="country_id" id="recipe-country-select" onchange="loadRecipeStates()" style="margin-bottom: 0.5rem;">
                            <option value="">No Country</option>
                            {% for country in countries %}
                            <option value="{{ country.id }}" {% if recipe.primary_country_id == country.id %}selected{% endif %}>{{ country.name }}</option>
                            {% endfor %}
                        </select>
                        <select name="state_id" id="recipe-state-select">
                            <option value="">No State</option>
                            {% if recipe.primary_country_id %}
                                {% for state in states %}
                                    {% if state.country_id == recipe.primary_country_id %}
                                    <option value="{{ state.id }}" {% if recipe.primary_state_id == state.id %}selected{% endif %}>{{ state.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="action-buttons">
                        <button type="submit">Save</button>
                        <button type="button" onclick="disableEditMode()" class="btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="steps-section">
            <h2>Steps</h2>
            <ul class="steps-list" id="steps-list">
            {% for step in recipe.steps %}
            <li class="step" draggable="{% if is_owner %}true{% else %}false{% endif %}" data-step-id="{{ step.id }}" data-step-number="{{ step.step_number }}">
                {% if is_owner %}
                <span class="drag-handle">⋮⋮</span>
                {% endif %}
                <span class="step-number">Step {{ step.step_number }}</span>
                <div class="step-content">
                    <div class="step-text view-mode step-text-view-{{ step.id }}" onclick="{% if is_owner %}startEditStep({{ step.id }}){% endif %}">
                        {{ step.step_text }}
                    </div>
                    <input type="text" class="step-text-input edit-mode step-text-edit-{{ step.id }}" style="display: none;" value="{{ step.step_text }}" data-step-id="{{ step.id }}">
                    <div class="ingredients-container">
                        {% for ingredient in step.ingredients %}
                        <div class="ingredient-chip" data-ingredient-id="{{ ingredient.id }}">
                            <span class="ingredient-name view-mode ingredient-view-{{ ingredient.id }}" onclick="{% if is_owner %}startEditIngredient({{ ingredient.id }}){% endif %}">{{ ingredient.name }}</span>
                            <span class="ingredient-amount view-mode ingredient-view-{{ ingredient.id }}" onclick="{% if is_owner %}startEditIngredient({{ ingredient.id }}){% endif %}">({{ ingredient.amount }})</span>
                            {% if is_owner %}
                            <form method="POST" action="{{ url_for('delete_ingredient', recipe_id=recipe.id, ingredient_id=ingredient.id) }}" style="display: inline;" onsubmit="return confirm('Delete this ingredient?');">
                                <button type="submit" class="delete-btn">×</button>
                            </form>
                            {% endif %}
                        </div>
                        <div class="ingredient-edit-form ingredient-edit-{{ ingredient.id }}" style="display: none;">
                            <form method="POST" action="{{ url_for('edit_ingredient', recipe_id=recipe.id, ingredient_id=ingredient.id) }}" class="ingredient-edit-form-content">
                                <input type="text" name="name" value="{{ ingredient.name }}" required>
                                <input type="text" name="amount" value="{{ ingredient.amount }}" required>
                                <button type="submit" class="btn-small">Save</button>
                                <button type="button" onclick="cancelIngredientEdit({{ ingredient.id }})" class="btn-secondary btn-small">Cancel</button>
                            </form>
                        </div>
                        {% endfor %}
                        {% if is_owner %}
                        <button class="new-ingredient-btn" onclick="showNewIngredientForm({{ step.id }})">+ Ingredient</button>
                        <div class="new-ingredient-form" id="new-ingredient-form-{{ step.id }}">
                            <form method="POST" action="{{ url_for('add_ingredient', recipe_id=recipe.id, step_id=step.id) }}" class="new-ingredient-form-content">
                                <input type="text" name="name" placeholder="Ingredient name" required>
                                <input type="text" name="amount" placeholder="Amount" required>
                                <button type="submit" class="btn-small">Add</button>
                                <button type="button" onclick="hideNewIngredientForm({{ step.id }})" class="btn-secondary btn-small">Cancel</button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="step-actions">
                    {% if is_owner %}
                    <form method="POST" action="{{ url_for('delete_step', recipe_id=recipe.id, step_id=step.id) }}" style="display: inline;" onsubmit="return confirm('Delete this step?');">
                        <button type="submit" class="btn-danger btn-small">Delete</button>
                    </form>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
            </ul>
            
            {% if is_owner %}
            <div class="new-step-form" id="new-step-form">
                <form method="POST" action="{{ url_for('add_step', recipe_id=recipe.id) }}" class="new-step-form-content" id="new-step-form-content">
                    <input type="text" name="step_text" placeholder="Enter step instructions..." required id="new-step-text-input">
                    <button type="button" class="new-ingredient-btn" id="new-step-ingredient-btn" onclick="showNewStepIngredientForm()" style="display: none;">+ Ingredient</button>
                    <div class="new-step-form-actions">
                        <button type="submit" class="btn-small">Add Step</button>
                        <button type="button" onclick="hideNewStepForm()" class="btn-secondary btn-small">Cancel</button>
                    </div>
                </form>
                <div class="new-ingredient-form" id="new-step-ingredient-form" style="display: none; position: relative; margin-top: 0.5rem;">
                    <div style="padding: 0.5rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 3px; margin-bottom: 0.5rem; font-size: 0.85rem; color: #856404;">
                        Note: Ingredients can be added after the step is created.
                    </div>
                    <div class="new-ingredient-form-content">
                        <input type="text" name="name" placeholder="Ingredient name" id="new-step-ingredient-name">
                        <input type="text" name="amount" placeholder="Amount" id="new-step-ingredient-amount">
                        <button type="button" class="btn-small" onclick="hideNewStepIngredientForm()">Cancel</button>
                    </div>
                </div>
            </div>
            <button class="new-step-btn" onclick="showNewStepForm()">+ New Step</button>
            {% endif %}
        </div>
    </div>
    
    <script>
        function enableEditMode() {
            document.getElementById('recipe-name-view').classList.add('hidden');
            document.getElementById('recipe-name-edit').classList.add('active');
        }
        
        function disableEditMode() {
            document.getElementById('recipe-name-view').classList.remove('hidden');
            document.getElementById('recipe-name-edit').classList.remove('active');
        }
        
        function showNewStepForm() {
            const form = document.getElementById('new-step-form');
            form.classList.add('active');
            const input = document.getElementById('new-step-text-input');
            if (input) input.focus();
        }
        
        function hideNewStepForm() {
            const form = document.getElementById('new-step-form');
            form.classList.remove('active');
            const input = document.getElementById('new-step-text-input');
            if (input) input.value = '';
            hideNewStepIngredientForm();
            const btn = document.getElementById('new-step-ingredient-btn');
            if (btn) btn.style.display = 'none';
        }
        
        function showNewStepIngredientForm() {
            const form = document.getElementById('new-step-ingredient-form');
            if (form) {
                form.style.display = 'block';
                const nameInput = document.getElementById('new-step-ingredient-name');
                if (nameInput) nameInput.focus();
            }
        }
        
        function hideNewStepIngredientForm() {
            const form = document.getElementById('new-step-ingredient-form');
            if (form) {
                form.style.display = 'none';
                const nameInput = document.getElementById('new-step-ingredient-name');
                const amountInput = document.getElementById('new-step-ingredient-amount');
                if (nameInput) nameInput.value = '';
                if (amountInput) amountInput.value = '';
            }
        }
        
        function showNewIngredientForm(stepId) {
            const form = document.getElementById('new-ingredient-form-' + stepId);
            if (form) {
                form.classList.add('active');
                form.querySelector('input[name="name"]').focus();
            }
        }
        
        function hideNewIngredientForm(stepId) {
            const form = document.getElementById('new-ingredient-form-' + stepId);
            if (form) {
                form.classList.remove('active');
                const nameInput = form.querySelector('input[name="name"]');
                const amountInput = form.querySelector('input[name="amount"]');
                if (nameInput) nameInput.value = '';
                if (amountInput) amountInput.value = '';
            }
        }
        
        let editingStepId = null;
        
        function startEditStep(stepId) {
            if (editingStepId === stepId) return;
            
            // Cancel any other editing
            if (editingStepId !== null) {
                cancelStepEdit(editingStepId);
            }
            
            editingStepId = stepId;
            const viewEl = document.querySelector('.step-text-view-' + stepId);
            const editEl = document.querySelector('.step-text-edit-' + stepId);
            if (viewEl && editEl) {
                viewEl.style.display = 'none';
                editEl.style.display = 'block';
                editEl.focus();
                editEl.select();
                
                const saveHandler = function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        saveStepEdit(stepId);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelStepEdit(stepId);
                    }
                };
                
                const blurHandler = function() {
                    saveStepEdit(stepId);
                };
                
                editEl.addEventListener('blur', blurHandler, { once: true });
                editEl.addEventListener('keydown', saveHandler, { once: true });
            }
        }
        
        function cancelStepEdit(stepId) {
            const viewEl = document.querySelector('.step-text-view-' + stepId);
            const editEl = document.querySelector('.step-text-edit-' + stepId);
            if (viewEl && editEl) {
                editEl.value = viewEl.textContent.trim();
                viewEl.style.display = 'block';
                editEl.style.display = 'none';
                editingStepId = null;
            }
        }
        
        function saveStepEdit(stepId) {
            if (editingStepId !== stepId) return;
            
            const editEl = document.querySelector('.step-text-edit-' + stepId);
            if (!editEl) {
                editingStepId = null;
                return;
            }
            
            const stepText = editEl.value.trim();
            if (!stepText) {
                cancelStepEdit(stepId);
                return;
            }
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("edit_step", recipe_id=recipe.id, step_id=0) }}'.replace('0', stepId);
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'step_text';
            input.value = stepText;
            form.appendChild(input);
            
            document.body.appendChild(form);
            editingStepId = null;
            form.submit();
        }
        
        function startEditIngredient(ingredientId) {
            const viewEls = document.querySelectorAll('.ingredient-view-' + ingredientId);
            const editEl = document.querySelector('.ingredient-edit-' + ingredientId);
            if (viewEls.length > 0 && editEl) {
                viewEls.forEach(el => el.style.display = 'none');
                editEl.classList.add('active');
                editEl.querySelector('input[name="name"]').focus();
            }
        }
        
        function cancelIngredientEdit(ingredientId) {
            const viewEls = document.querySelectorAll('.ingredient-view-' + ingredientId);
            const editEl = document.querySelector('.ingredient-edit-' + ingredientId);
            if (viewEls.length > 0 && editEl) {
                viewEls.forEach(el => el.style.display = 'inline');
                editEl.classList.remove('active');
            }
        }
        
        function loadRecipeStates() {
            const countryId = document.getElementById('recipe-country-select').value;
            const stateSelect = document.getElementById('recipe-state-select');
            stateSelect.innerHTML = '<option value="">No State</option>';
            
            if (countryId) {
                fetch('/api/states/' + countryId)
                    .then(response => response.json())
                    .then(data => {
                        data.states.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state.id;
                            option.textContent = state.name;
                            stateSelect.appendChild(option);
                        });
                    });
            }
        }
        
        // Show new ingredient button on hover for existing steps and new step form
        {% if is_owner %}
        document.addEventListener('DOMContentLoaded', function() {
            // Show new ingredient button on hover for existing steps
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => {
                const newIngredientBtn = step.querySelector('.new-ingredient-btn');
                if (newIngredientBtn) {
                    step.addEventListener('mouseenter', function() {
                        newIngredientBtn.style.display = 'inline-block';
                    });
                    step.addEventListener('mouseleave', function() {
                        const form = step.querySelector('.new-ingredient-form.active');
                        if (!form) {
                            newIngredientBtn.style.display = 'none';
                        }
                    });
                }
            });
            
            // Show new ingredient button on hover when creating new step
            const newStepForm = document.getElementById('new-step-form');
            const newStepIngredientBtn = document.getElementById('new-step-ingredient-btn');
            if (newStepForm && newStepIngredientBtn) {
                newStepForm.addEventListener('mouseenter', function() {
                    if (newStepForm.classList.contains('active')) {
                        newStepIngredientBtn.style.display = 'inline-block';
                    }
                });
                newStepForm.addEventListener('mouseleave', function() {
                    const form = newStepForm.querySelector('#new-step-ingredient-form');
                    if (!form || form.style.display === 'none') {
                        newStepIngredientBtn.style.display = 'none';
                    }
                });
            }
        });
        {% endif %}
        
        // Drag and drop functionality
        {% if is_owner %}
        let draggedElement = null;
        const stepsList = document.getElementById('steps-list');
        
        stepsList.addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('step') || e.target.closest('.step')) {
                const step = e.target.classList.contains('step') ? e.target : e.target.closest('.step');
                draggedElement = step;
                step.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', step.outerHTML);
            }
        });
        
        stepsList.addEventListener('dragend', function(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
        });
        
        stepsList.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(stepsList, e.clientY);
            const dragging = document.querySelector('.dragging');
            
            if (dragging && afterElement == null) {
                stepsList.appendChild(dragging);
            } else if (dragging && afterElement) {
                stepsList.insertBefore(dragging, afterElement);
            }
        });
        
        stepsList.addEventListener('drop', function(e) {
            e.preventDefault();
            if (draggedElement) {
                updateStepOrder();
            }
        });
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.step:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function updateStepOrder() {
            const steps = stepsList.querySelectorAll('.step');
            const stepOrders = [];
            
            steps.forEach((step, index) => {
                const stepId = step.getAttribute('data-step-id');
                stepOrders.push({
                    step_id: parseInt(stepId),
                    step_number: index + 1
                });
                
                // Update displayed step number
                const stepNumberEl = step.querySelector('.step-number');
                if (stepNumberEl) {
                    stepNumberEl.textContent = 'Step ' + (index + 1);
                }
            });
            
            // Send update to server
            fetch('{{ url_for("update_step_order", recipe_id=recipe.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ step_orders: stepOrders })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update data attributes
                    steps.forEach((step, index) => {
                        step.setAttribute('data-step-number', index + 1);
                    });
                }
            })
            .catch(error => {
                console.error('Error updating step order:', error);
            });
        }
        {% endif %}
    </script>
</body>
</html>
